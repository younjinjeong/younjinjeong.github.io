<!-- Mobile Navigation Controls - Fallout Style -->
<div class="mobile-nav-controls" id="mobileNavControls">
  <!-- Left Section: Back Button -->
  <button class="nav-control nav-back" id="navBack" aria-label="Go back">
    <svg viewBox="0 0 24 24" width="20" height="20">
      <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" fill="currentColor"/>
    </svg>
  </button>
  
  <!-- Center Section: Menu Button -->
  <button class="nav-control nav-menu" id="navMenu" aria-label="Open menu">
    <div class="menu-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <span class="nav-label">MENU</span>
  </button>
  
  <!-- Right Section: Forward Button -->
  <button class="nav-control nav-forward" id="navForward" aria-label="Go forward">
    <svg viewBox="0 0 24 24" width="20" height="20">
      <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z" fill="currentColor"/>
    </svg>
  </button>
</div>

<style>
/* Mobile Navigation Controls */
.mobile-nav-controls {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: var(--pipboy-bg);
  border-top: 2px solid var(--pipboy-green);
  padding: 0 24px;
  padding-bottom: env(safe-area-inset-bottom, 0px);
  z-index: 100;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 -2px 20px rgba(76, 175, 80, 0.3);
  
  /* Scanline effect */
  background-image: 
    linear-gradient(
      rgba(76, 175, 80, 0.03) 50%,
      transparent 50%
    );
  background-size: 100% 2px;
}

/* Show only on mobile */
@media (max-width: 768px) {
  .mobile-nav-controls {
    display: flex;
  }
  
  /* Add padding to container to prevent content overlap */
  .container {
    padding-bottom: 70px;
  }
  
  /* Adjust footer margin */
  footer {
    margin-bottom: 60px;
  }
}

.nav-control {
  background: transparent;
  border: 1px solid var(--pipboy-green);
  color: var(--pipboy-green);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 6px;
  font-family: var(--pipboy-terminal-font);
  font-size: 12px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
  min-width: 60px;
  justify-content: center;
}

/* Back and Forward buttons - circular */
.nav-back, .nav-forward {
  padding: 10px;
  border-radius: 50%;
  min-width: 44px;
  width: 44px;
  height: 44px;
}

/* Menu button - wider with icon and text */
.nav-menu {
  flex: 0 0 auto;
  padding: 8px 20px;
  border-radius: 20px;
  gap: 8px;
}

/* Menu icon hamburger */
.menu-icon {
  width: 18px;
  height: 14px;
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.menu-icon span {
  display: block;
  height: 2px;
  width: 100%;
  background: var(--pipboy-green);
  transition: all 0.3s ease;
  transform-origin: center;
}

/* Animate menu icon when active */
.nav-menu.active .menu-icon span:nth-child(1) {
  transform: translateY(6px) rotate(45deg);
}

.nav-menu.active .menu-icon span:nth-child(2) {
  opacity: 0;
}

.nav-menu.active .menu-icon span:nth-child(3) {
  transform: translateY(-6px) rotate(-45deg);
}

.nav-control:before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: var(--pipboy-green);
  opacity: 0.2;
  transition: left 0.3s ease;
}

.nav-control:active:before {
  left: 0;
}

.nav-control:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.nav-control:not(:disabled):hover {
  border-color: var(--pipboy-light-green);
  text-shadow: 0 0 5px var(--pipboy-green);
  box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
}

.nav-control:not(:disabled):active {
  transform: scale(0.95);
}

.nav-control svg {
  width: 20px;
  height: 20px;
}

.nav-label {
  font-weight: bold;
  letter-spacing: 1px;
  font-size: 11px;
}

@keyframes pulse {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 1; }
}

/* Sound feedback visual */
.nav-control.nav-pressed {
  animation: navPress 0.2s ease;
}

@keyframes navPress {
  0% { transform: scale(1); }
  50% { transform: scale(0.9); }
  100% { transform: scale(1); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const navBack = document.getElementById('navBack');
  const navForward = document.getElementById('navForward');
  const navMenu = document.getElementById('navMenu');
  const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
  const pipboyNav = document.querySelector('.pipboy-nav');
  const mobileOverlay = document.querySelector('.mobile-overlay');
  
  // Hide the original floating hamburger menu on mobile
  if (mobileMenuToggle) {
    mobileMenuToggle.style.display = 'none';
  }
  
  // Menu toggle functionality
  function toggleMenu() {
    const isActive = navMenu.classList.contains('active');
    
    if (isActive) {
      closeMenu();
    } else {
      openMenu();
    }
  }
  
  function openMenu() {
    navMenu.classList.add('active');
    pipboyNav.classList.add('mobile-active');
    mobileOverlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    playNavSound();
  }
  
  function closeMenu() {
    navMenu.classList.remove('active');
    pipboyNav.classList.remove('mobile-active');
    mobileOverlay.classList.remove('active');
    document.body.style.overflow = '';
  }
  
  // Update navigation state
  function updateNavState() {
    // Check if browser supports navigation
    if (typeof window.history !== 'undefined') {
      // We can't directly check history length, but we can enable/disable based on user action
      navBack.disabled = !window.history.length || window.history.length <= 1;
      navForward.disabled = false; // Will be updated based on navigation
    }
  }
  
  // Navigation functions
  function navigateBack() {
    if (!navBack.disabled) {
      playNavSound();
      navBack.classList.add('nav-pressed');
      setTimeout(() => navBack.classList.remove('nav-pressed'), 200);
      
      // Show loading screen before navigation
      const loadingScreen = document.getElementById('loadingScreen');
      if (loadingScreen) {
        loadingScreen.style.display = 'flex';
      }
      
      setTimeout(() => {
        window.history.back();
      }, 100);
    }
  }
  
  function navigateForward() {
    if (!navForward.disabled) {
      playNavSound();
      navForward.classList.add('nav-pressed');
      setTimeout(() => navForward.classList.remove('nav-pressed'), 200);
      
      // Show loading screen before navigation
      const loadingScreen = document.getElementById('loadingScreen');
      if (loadingScreen) {
        loadingScreen.style.display = 'flex';
      }
      
      setTimeout(() => {
        window.history.forward();
      }, 100);
    }
  }
  
  // Play navigation sound
  function playNavSound() {
    try {
      const audio = new Audio('/sounds/tv-channel-change.mp3');
      audio.volume = 0.3;
      audio.play().catch(err => console.log('Could not play nav sound:', err));
    } catch (err) {
      console.log('Audio not supported:', err);
    }
  }
  
  // Event listeners
  navBack.addEventListener('click', navigateBack);
  navForward.addEventListener('click', navigateForward);
  navMenu.addEventListener('click', toggleMenu);
  
  // Close menu when clicking overlay or nav links
  if (mobileOverlay) {
    mobileOverlay.addEventListener('click', closeMenu);
  }
  
  const navLinks = document.querySelectorAll('.pipboy-nav a');
  navLinks.forEach(link => {
    link.addEventListener('click', () => {
      if (pipboyNav.classList.contains('mobile-active')) {
        closeMenu();
      }
    });
  });
  
  // Swipe gestures for navigation and menu
  let touchStartX = 0;
  let touchStartY = 0;
  let touchEndX = 0;
  let touchEndY = 0;
  
  document.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
  }, { passive: true });
  
  document.addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    handleSwipe();
  }, { passive: true });
  
  function handleSwipe() {
    const swipeThreshold = 50;
    const diffX = touchEndX - touchStartX;
    const diffY = touchEndY - touchStartY;
    
    // Only handle horizontal swipes
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > swipeThreshold) {
      // Check if menu is open
      if (pipboyNav.classList.contains('mobile-active')) {
        if (diffX < 0) {
          // Swipe left - close menu
          closeMenu();
        }
      } else {
        // Menu is closed, handle navigation
        if (diffX > 0 && touchStartX < 50) {
          // Swipe right from left edge - open menu
          openMenu();
        } else if (diffX > swipeThreshold && touchStartX < 30) {
          // Swipe right from left edge only - go back
          navigateBack();
        } else if (diffX < -swipeThreshold && touchStartX > window.innerWidth - 30) {
          // Swipe left from right edge only - go forward
          navigateForward();
        }
      }
    }
  }
  
  // Update state on page load and navigation
  updateNavState();
  window.addEventListener('popstate', updateNavState);
  
  // Track navigation to update forward button state
  let canGoForward = false;
  window.addEventListener('beforeunload', function() {
    sessionStorage.setItem('previousPage', window.location.href);
  });
  
  // Check if we came from a previous page
  const previousPage = sessionStorage.getItem('previousPage');
  if (previousPage && previousPage !== window.location.href) {
    canGoForward = false;
  }
  
  // Update forward button based on navigation
  navForward.disabled = !canGoForward;
});
</script>